<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="renderer" content="webkit">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>实景示例</title>
  <link rel="stylesheet" href="./public/scripts/HMap/HMap.css" type="text/css">
  <link rel="stylesheet" href="./public/scripts/Bootstrap/css/bootstrap.min.css"></link>
  <style type="text/css">
    html, body, .container-fluid, .row {
      height: 100%;
      overflow: hidden;
    }
    .map-content {
      height: 100%;
      border: 1px solid #2d2d2d;
      box-sizing: border-box;
      padding: 0px;
    }
    .pano-content {
      height: 100%;
      border: 1px solid #2d2d2d;
      box-sizing: border-box;
      padding: 0px;
    }
    .ppv_toolbar {
      height: 30px;
      line-height: 30px;
      position: absolute;
      top: 0px;
    }
    .ppv_toolbar img {
      width: 50px;
      height: 50px;
    }
    .ppv_toolbar img:hover {
      background-color: #2387c0;
      cursor: pointer;
    }
    .play-button {
      float: left;
      background-color: rgba(0, 0, 0, 0.2);
    }
    .play-button .play {

    }
    .play-button .stop {
      display: none;
    }
    .my-button-add {
      position: absolute;
      top: 20px;
      left: calc(50% - 48px);
      z-index: 10;
    }
    .my-button-rm {
      position: absolute;
      top: 20px;
      left: calc(50% + 96px + 20px);
      z-index: 10;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6 map-content" id="map">
      <button type="button" class="btn btn-success my-button-add" onclick="addPointLayer()">叠加点图层</button>
      <button type="button" class="btn btn-info my-button-rm" onclick="removePointLayer()">移除叠加点图层</button>
    </div>
    <div class="col-md-6 pano-content" id="ppv">
      <div class="ppv_toolbar">
        <img class="ppv_button" src="public/icon/searchCoor.png" title="查询坐标" onclick="activeTool('measurePoint')"></img>
        <img class="ppv_button" src="public/icon/measureLength.png" title="测量长度" onclick="activeTool('measureLength')"></img>
        <img class="ppv_button" src="public/icon/measureArea.png" title="测量面积" onclick="activeTool('measureArea')"></img>
        <img class="ppv_button" src="public/icon/measureheigth.png" title="测量垂距" onclick="activeTool('measureZ')"></img>
        <img class="ppv_button" src="public/icon/measureLimian.png" title="测量立面" onclick="activeTool('measureFacade')"></img>
        <img class="ppv_button" src="public/icon/measurejiaodu.png" title="测量角度" onclick="activeTool('measureAngle')"></img>
        <img class="ppv_button" src="public/icon/measurepodu.png" title="测量坡度" onclick="activeTool('measureSlope')"></img>
        <img class="ppv_button" src="public/icon/creatPoint.png" title="创建点" onclick="activeTool('createPoint')"></img>
        <img class="ppv_button" src="public/icon/creatLine.png" title="创建线" onclick="activeTool('createPolyline')"></img>
        <img class="ppv_button" src="public/icon/creatArea.png" title="创建面" onclick="activeTool('createPolygon')"></img>
        <img class="ppv_button" src="public/icon/selObject.png" title="选择对象" onclick="activeTool('pick')"></img>
        <img class="ppv_button" src="public/icon/delObject.png" title="删除选中对象" onclick="activeTool('remove')"></img>
        <img class="ppv_button" src="public/icon/LRS.png" title="线性参考系"></img>
        <div class="play-button">
          <img class="ppv_button play" onclick="play()" src="public/icon/play.png" title="播放"></img>
          <img class="ppv_button stop" onclick="stop()" src="public/icon/stop.png" title="暂停"></img>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="./public/scripts/jquery/jquery.min.js"></script>
<script src="./public/scripts/ResizeEnd/resizeEnd.js"></script>
<script src="./public/scripts/Bootstrap/js/bootstrap.min.js"></script>
<script src="./public/scripts/axios/axios.min.js"></script>
<script src="./public/scripts/HMap/HMap.min.js"></script>
<script src="./public/scripts/PPV/js/ppv.min.js"></script>
<script src="./mapConfig.js"></script>
<script type="text/javascript">
  var resolutions = [], ppv, pointFeature;
  for (var i = 0; i < cor.length; i++) {
    resolutions.push(cor[i].resolution);
  }
  var Maps = new HMap.Map();

  // 初始化地图
  Maps.initMap('map', {
    interactions: {
      altShiftDragRotate: true,
      doubleClickZoom: true,
      keyboard: true,
      mouseWheelZoom: true,
      shiftDragZoom: true,
      dragPan: true,
      pinchRotate: true,
      pinchZoom: true,
      zoomDelta: 1, // 缩放增量（默认一级）
      zoomDuration: 500 // 缩放持续时间
    },
    controls: {
      attribution: true,
      attributionOptions: {
        className: 'ol-attribution',
        target: 'attributionTarget'
      },
      rotate: true,
      zoom: true,
      overViewMapVisible: false,
      scaleLineVisible: true
    },
    view: {
      center: [115.92466595234826, 27.428038204473552],
      resolutions: resolutions,
      fullExtent: [109.72859368643232, 24.010266905347684, 121.13105988819079, 30.76693489432357],
      tileSize: 256,
      origin: [-400, 399.9999999999998],
      enableRotation: true, // 是否允许旋转
      projection: 'EPSG:4326',
      rotation: 0,
      zoom: 1, // resolution
      zoomFactor: 2 // 用于约束分变率的缩放因子（高分辨率设备需要注意）
    },
    logo: {},
    baseLayers: [  // 不传时默认加载OSM地图。
      {
        layerName: 'vector',
        isDefault: true,
        layerType: 'TileXYZ',
        opaque: false, //图层是否不透明
        layerUrl: 'http://171.34.40.68:6080/arcgis/rest/services/jiangxi/JXMAP_2017_2/MapServer',
      },
      {
        layerName: 'earth',
        layerType: 'TitleWMTS',
        layer: 'img',
        isDefault: false,
        layerUrl: 'http://t{0-6}.tianditu.cn/img_c/wmts',
        label: {
          layerName: 'TDTLabel',
          layerType: 'TitleWMTS',
          layer: 'cia',
          alias: 'earth',
          isDefault: false,
          layerUrl: 'http://t{0-6}.tianditu.cn/cia_c/wmts'
        }
      },
      {
        layerName: 'panorama',
        layerType: 'TitleWMTS',
        layer: 'ter',
        isDefault: false,
        layerUrl: 'http://t{0-6}.tianditu.com/ter_c/wmts',
        label: {
          layerName: 'TDTLabel',
          layerType: 'TitleWMTS',
          layer: 'cia',
          alias: 'panorama',
          isDefault: false,
          layerUrl: 'http://t{0-6}.tianditu.cn/cia_c/wmts'
        }
      }
    ]
  });

  // 当页面变化刷新地图
  $(window).resizeend({
    delay: 50
  }, function () {
    Maps.updateSize();
  });

  // 监听地图左键事件
  Maps.map.on('mouseDownEvent', function (event) {
    var coordinate = event.originEvent.coordinate;
    var feature = event.value;
    if (feature && coordinate && feature.getGeometry()) {
      var closestPoint = feature.getGeometry().getClosestPoint(coordinate);
      if (closestPoint) {
        console.log(closestPoint)
        ppv.locate(3, closestPoint[0], closestPoint[1], 0);
      }
    }
  })

  addLine();

  // 添加实景所在路线
  function addLine () {
    axios.get('./public/json/line.json')
      .then(function (response) {
        var line = response['data']['data']['features'][0];
        line['attributes']['style'] = {
          stroke: {
            strokeWidth: 4,
            strokeColor: '#0000EE'
          }
        }
        line['attributes']['selectStyle'] = {
          stroke: {
            strokeWidth: 6,
            strokeColor: '#E52929'
          }
        }
        var feat = Maps.addPolyline(line, {
          layerName: 'line',
          zoomToExtent: true
        });

        var point = {
          attributes: {
            ID: '02',
            style: { // 自定义相关样式
              icon: {
                imageSrc: './public/icon/jiaodu.png'
              }
            }
          },
          geometry: [115.87258481455471, 26.380662006921387],
          geometryType: 'Point'
        };
        pointFeature = Maps.addPoint(point, {
          layerName: 'point'
        });

        var ptx, pty;
        ptx = 115.87258481455471;
        pty = 26.380662006921387;
        initPano(ptx, pty)
      })
      .catch(function (error) {
        console.log(error);
      });
  }

  // 响应位置变化事件
  function onPosition(event) {
    var lon = event.lon;
    var lat = event.lat;
    var xx = 0;
    Maps.setPointGeometry(pointFeature, [lon, lat])
  }

  // 响应角度变化事件
  function onEye(event) {
    var heading = event.heading;
    var fovx = event.fovx;
    console.log(heading);
    pointFeature.getStyle().getImage().setRotation(heading)
  }
  // 响应创建要素(点)
  var fid = 0;
  function onFeatureCreate (event){
    console.log(event)
    fid++;
    event.fid = fid;
    event.name = "我是" + event.geometry.type + fid;
    var icon = 'public/icon/point_' + parseInt(Math.random()*4 + 1, 10) + '.png'
    event.icon = icon;
    var layerPointDef = {
      name:"路灯",
      type:"Point",//Point, Line, Polygon 三种类型，并非强约束
      color:0xffffff,//RGBA or RGB
      opacity:1.0,
      size: 20,
      offset:[0,20],
      fontSize: 14,
      icon: icon
    };
    var layerLineDef = {
      name:"分道线",
      type:"Line",//Point, Line, Polygon 三种类型，并非强约束
      color:"rgb(255,0,255)",//RGBA or RGB
      opacity:1,
      lineWidth:4,
      fontSize:15
    };
    var layerPolyDef = {
      name:"箭头",
      type:"Polygon",//Point, Line, Polygon 三种类型，并非强约束
      color:'skyblue',//RGBA or RGB
      opacity:0.5,
      lineWidth:4,
      fontSize:15
    };
    var layerPoint = ppv.addLayer(layerPointDef);
    var layerLine = ppv.addLayer(layerLineDef);
    var layerPoly = ppv.addLayer(layerPolyDef);
    var type = event.geometry.type;
    if (type == "Point") {
      ppv.addFeature(layerPoint, event);
    } else if (type == "LineString") {
      ppv.addFeature(layerLine, event);
    } else if (type == "Polygon") {
      ppv.addFeature(layerPoly, event);
    }
    creatFeatureOnMapView(event)
  }

  function creatFeatureOnMapView (event) {
    var _point = {
      attributes: {
        ID: event['fid'],
        style: { // 自定义相关样式
          icon: {
            imageSrc: event['icon']
          }
        },
        M: event['geometry']['coordinates'][3]
      },
      geometry: [event['geometry']['coordinates'][0], event['geometry']['coordinates'][1]],
      geometryType: 'Point'
    }
    Maps.addPoint(_point, {
      layerName: 'point'
    });
  }
  // 响应要素被选择
  function onFeatureSelect (event){
    var fid = event.fid;
    console.log(fid)
  }
  // 响应要素被移除
  function onFeatureRemove (event){
    var fid = event.fid;
    console.log(fid)
  }

  // 初始化实景控件
  function initPano(ptx, pty) {
    ppv = new PPV("ppv");
    ppv.setServer("http://211.101.37.253:8013//PPVServer.asmx");
    ppv.locate(3, ptx, pty, 0);
    ppv.onPosition = onPosition;
    ppv.onEye = onEye;
    ppv.onFeatureCreate = onFeatureCreate;
    ppv.onFeatureSelect = onFeatureSelect;
    ppv.onFeatureRemove = onFeatureRemove;
  }
  // 实景工具类
  function activeTool (type) {
    switch (type) {
      case 'measurePoint':
        ppv.setTool(Tool.measurePoint, true);
        break;
      case 'measureLength':
        ppv.setTool(Tool.measureLength, true);
        break;
      case 'measureArea':
        ppv.setTool(Tool.measureArea, true);
        break;
      case 'measureZ':
        ppv.setTool(Tool.measureZ, true);
        break;
      case 'measureFacade':
        ppv.setTool(Tool.measureFacade, true);
        break;
      case 'measureAngle':
        ppv.setTool(Tool.measureAngle, true);
        break;
      case 'measureSlope':
        ppv.setTool(Tool.measureSlope, true);
        break;
      case 'createPoint':
        ppv.setTool(Tool.createPoint, true);
        break;
      case 'createPolyline':
        ppv.setTool(Tool.createPolyline, true);
        break;
      case 'createPolygon':
        ppv.setTool(Tool.createPolygon, true);
        break;
      case 'pick':
        ppv.setTool(Tool.pick, true);
        break;
      case 'remove':
        ppv.setTool(Tool.remove, true);
        break;
    }
  }
  // 播放
  function play () {
    ppv.play()
    $('.play').css('display', 'none')
    $('.stop').css('display', 'block')
  }
  // 暂停
  function stop () {
    ppv.stop()
    $('.play').css('display', 'block')
    $('.stop').css('display', 'none')
  }
  // 外部叠加点要素
  function addPointLayer () {
    axios.get('./public/json/live-list.json')
      .then(function (response) {
        var pointFeat = response['data']['data']['features']
        var icon = 'public/icon/point_' + parseInt(Math.random()*4 + 1, 10) + '.png'
        var _layerPointDef = {
          name:"桥梁",
          type:"Point",//Point, Line, Polygon 三种类型，并非强约束
          color:0xffffff,//RGBA or RGB
          opacity:1.0,
          size: 20,
          offset:[0,20],
          fontSize: 14,
          icon: icon
        };
        var _layerPoint = ppv.addLayer(_layerPointDef);
        pointFeat.forEach(function (item) {
          item['attributes'].style = { // 自定义相关样式
            icon: {
              imageSrc: 'public/icon/point_1.png'
            }
          }
          var __item = {
            fid: item['attributes']['QLDM'],
            geometry: {
              coordinates: [item['geometry'][0], item['geometry'][1], 200.5938781674623],
              type: "Point"
            },
            icon: icon,
            name: item['attributes']['QLMC'],
            toGround: 0,
            type: "Feature"
          }
          Maps.addPoint(item, {
            layerName: 'pointFeat'
          });
          ppv.addFeature(_layerPoint, __item);
        })
      })
      .catch(function (error) {
        console.log(error);
      });
  }
  // 移除叠加要素
  function removePointLayer () {
    Maps.removeFeatureByLayerName('pointFeat')
  }
</script>
</body>
</html>